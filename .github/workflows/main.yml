name: "skivori Infra code"

on:
  push:
    branches:
      - main
  
env:
 # Credentails for infra deployment

 AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
 AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

 # S3 bucket for the Terraform state
 BUCKET_TF_STATE: ${{ secrets.BUCKET_TF_STATE }} 
 AWS_REGION: eu-central-1
 EKS_CLUSTER: skivoriterrastate


jobs:
    terraform:
      name: "Apply terraform code changes"
      runs-on: ubuntu-latest
      defaults:
        run:
         shell: bash
         working-directory: ./terraform
      
      steps:
        
        - name: Checkout source code
          uses: actions/checkout@v4

        - name: Debug Directory Structure
          run: ls -R

        - name: Setup Terraform with specified version on the runner
          uses: hashicorp/setup-terraform@v2
          with:
            terraform_version: 1.9.8
        
        - name: Terraform init
          id: init
          run: terraform init -backend-config="bucket=$BUCKET_TF_STATE"

       # - name: Terraform format
       #   id: fmt
       ##   run: terraform fmt -check

        - name: terraform validate
          id: validate
          run: terraform validate
        
        - name: terraform plan
          id: plan
          run: terraform plan -no-color -input=false -out planfile
          continue-on-error: true

        - name: Terraform plan status
          if: steps.plan.outcome == 'failure'
          run: exit 1
        
       # - name: Terraform Apply
        #  id: deploy
         # if: github.ref == 'refs/heads/main'  && github.event_name == 'push'
          #run: terraform apply -auto-approve -input=false -parallelism=1 planfile

    terraform-destroy:
      name: "Destroy Terraform resources"
      runs-on: ubuntu-latest
      defaults:
        run:
         shell: bash
         working-directory: ./terraform
    
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'delete' # Trigger conditions for destroy

      steps:
       - name: Checkout source code
         uses: actions/checkout@v4

       - name: Debug Directory Structure
         run: ls -R

       - name: Setup Terraform with specified version on the runner
         uses: hashicorp/setup-terraform@v2
         with:
           terraform_version: 1.9.8

       - name: Terraform init
         id: init
         run: terraform init -backend-config="bucket=$BUCKET_TF_STATE"

       - name: Terraform Destroy
         id: destroy
         run: terraform destroy -auto-approve -input=false -parallelism=1